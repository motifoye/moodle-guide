# Контексты

### Системный и пользовательский контексты

При разработке плагинов в Moodle важно понимать, как работают **системный контекст** и **пользовательский контекст**. Эти концепции определяют, к какой области системы или пользователя имеет доступ ваш плагин, и как он может взаимодействовать с объектами Moodle.

***

### **Что такое контексты в Moodle?**

**Контексты** в Moodle — это иерархическая структура, которая определяет уровни доступа к различным частям системы.

Иерархия контекстов выглядит так:

1. **System (Системный контекст)** — глобальный уровень, охватывающий весь сайт Moodle.
2. **User (Пользовательский контекст)** — персональный уровень, связанный с конкретным пользователем.
3. **Category (Категория)** — контекст категории курсов.
4. **Course (Курс)** — уровень доступа к конкретному курсу.
5. **Module (Модуль)** — контекст конкретного модуля курса (например, задания, форума).
6. **Block (Блок)** — контекст отдельных блоков.
7. **Other (Прочие)** — специфические контексты, например, для группы или роли.

***

### **Системный контекст**

- **Глобальный доступ**: Системный контекст используется для действий, которые касаются всей системы Moodle, таких как управление пользователями, настройка глобальных плагинов, или доступ к настройкам всего сайта.
- **Пример использования**:
  - Проверка глобальных разрешений, например, если пользователь имеет роль администратора.
  - Настройка параметров конфигурации плагина, которые применяются ко всему сайту.

**Пример кода для работы с системным контекстом:**
```php
$systemcontext = context_system::instance();

// Проверка, имеет ли пользователь глобальное разрешение:
if (has_capability('moodle/site:config', $systemcontext)) {
    echo "Пользователь может изменять глобальные настройки.";
}
```

***

### **Пользовательский контекст**

- **Индивидуальный доступ**: Пользовательский контекст связан с конкретным пользователем. Используется для операций, касающихся личных данных или действий пользователя, таких как редактирование профиля или управление личным хранилищем.
- **Пример использования**:
  - Проверка прав доступа к личным данным пользователя.
  - Отображение информации, связанной с конкретным пользователем, в плагине.

**Пример кода для работы с пользовательским контекстом:**
```php
$userid = $USER->id;
$usercontext = context_user::instance($userid);

// Проверка прав доступа пользователя:
if (has_capability('moodle/user:editprofile', $usercontext)) {
    echo "Пользователь может редактировать свой профиль.";
}
```

***

### **Разработка плагина с учетом контекстов**

1. **Определение контекста в зависимости от назначения плагина**:
   - Если ваш плагин работает на уровне всей системы, используйте системный контекст.
   - Если плагин предназначен для работы с конкретным курсом, модулем или пользователем, выбирайте соответствующий контекст.

2. **Пример реализации для плагина**:

   **Системный плагин (например, настройка глобальных параметров):**
   ```php
   <?php
   namespace local_myplugin;

   use context_system;

   class settings_page {
       public function display_settings() {
           $context = context_system::instance();

           if (!has_capability('moodle/site:config', $context)) {
               throw new \moodle_exception('accessdenied', 'admin');
           }

           echo "Добро пожаловать в настройки плагина!";
       }
   }
   ```

   **Плагин для работы с пользователем:**
   ```php
   <?php
   namespace local_myplugin;

   use context_user;

   class user_dashboard {
       public function display_user_data($userid) {
           $context = context_user::instance($userid);

           if (!has_capability('moodle/user:viewdetails', $context)) {
               throw new \moodle_exception('accessdenied', 'admin');
           }

           echo "Информация о пользователе: {$userid}";
       }
   }
   ```

3. **Настройка доступа (capabilities)**:
   Чтобы плагин корректно работал с разными контекстами, необходимо прописать соответствующие **разрешения (capabilities)** в файле `db/access.php`.

   **Пример:**
   ```php
   <?php
   $capabilities = [
       'local/myplugin:view' => [
           'captype' => 'read',
           'contextlevel' => CONTEXT_USER,
           'archetypes' => [
               'student' => CAP_ALLOW,
               'teacher' => CAP_ALLOW,
           ],
       ],
       'local/myplugin:manage' => [
           'captype' => 'write',
           'contextlevel' => CONTEXT_SYSTEM,
           'archetypes' => [
               'manager' => CAP_ALLOW,
           ],
       ],
   ];
   ```

4. **Взаимодействие с различными контекстами**:
   Если плагин работает в нескольких контекстах (например, системный + пользовательский), важно учитывать, что проверка прав (`has_capability`) должна выполняться для каждого контекста отдельно.

***

### **Когда использовать определенные контексты?**

| Контекст        | Применение                                                                 |
|-----------------|---------------------------------------------------------------------------|
| **Системный**    | Глобальные настройки плагинов, управление пользователями, роли и права.   |
| **Пользовательский** | Данные пользователя, профиль, личное хранилище.                          |
| **Курс**         | Действия, относящиеся к курсам, например, доступ к ресурсам или модулям.   |
| **Модуль**       | Работа с конкретными модулями курса (задания, форумы и т.д.).             |

***

### **Рекомендации**

1. **Выбор контекста**:
   - Определите, для какой части Moodle разрабатывается плагин, и выберите подходящий контекст.
   - Используйте `context_system::instance()` для глобальных операций, а для более специфичных — соответствующий контекст (`context_user`, `context_course`, `context_module`).

2. **Следуйте иерархии контекстов**:
   - Всегда проверяйте права пользователя через `has_capability()` перед выполнением любых действий.

3. **Прописывайте разрешения (capabilities)**:
   - Каждое действие плагина должно быть связано с соответствующей способностью (capability), определенной в `db/access.php`.

4. **Тестируйте с разными ролями**:
   - Убедитесь, что плагин работает корректно для администраторов, преподавателей и студентов, учитывая их права доступа.

***

Таким образом, выбор и использование контекста зависит от назначения вашего плагина. Правильное управление контекстами и проверка прав доступа позволяют создавать безопасные и гибкие плагины для Moodle.
