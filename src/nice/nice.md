# Nice

Плагин, разрабатываемый, в целях изучения moodle и его API.

## Задачи

1. Добавить элемент навигации на страницу:
  
   Место для добавления - верхняя навигационная панель в теме оформления **Boost**

   ```html
   <nav class="navbar fixed-top navbar-light bg-white navbar-expand" aria-label="Навигация по сайту">
   ```

## Темы

Темы оформления могут серьёзно изменить подход к разработке определенного функционала, связанного с интерфейсом. Разные темы по-своему изменяют весь вид интерфейса. Они могут скрывать некоторые элементы или добавлять собственные.

### Boost

Так, например, тема оформления **Boost**, появилась в Moodle 3.2 и стала основной темой, сместив классическую. Но в настройках сайта можно вернуть классический вариант оформленя: `Администрирование → Внешний вид → Выбор темы`.

Boost убирает блоки навигации, которые в классическом оформлении были видны всегда, как правило, в левой боковой панели. Их заменила панель навигации или меню сверху. В левой боковой панели в курсах осталась навигация лишь по самому курсу.

> Есть страница документации, как [создать новую тему на основе Boost](https://docs.moodle.org/dev/Creating_a_theme_based_on_boost)

## Навигация

Boost довольно сильно изменяет работу навигации, при этом не давая четкого объяснения как с ней работать из кода плагинов. Да, старый API по-прежнему работает, но во всех случаях изменения видны.

В итоге, получаем ~~неработающий~~ видоизмененный стандартный API без документации.

Для добавления вкладок в верхнюю панель навигации приходится искать другие способы. Так, один из способов добавить элемент меню - зайти в настройки плагина и указать ссылку, которую хотите добавить в navbar: `Администрирование → Внешний вид → Расширенные настройки темы → Настраиваемые элементы меню`

Однако такой способ не даёт полностью контролировать этот элемент. Он всегда виден, даже когда человек не вошёл в систему.

### Работа с навигацией

> Я так и не нашел нормальной документации связанной с бустом и навигацией. Дальше, пишу по кусочкам информации: ChatGPT и другое.

Вот список некоторых хуков в Moodle, которые могут быть использованы для расширения и управления навигацией:

1. `core\hook\navigation\primary_extend`  
   Расширяет основное меню навигации. Этот хук позволяет добавлять дополнительные элементы в основное меню, например, новые вкладки или ссылки.

2. `core\hook\navigation\user_extend`  
   Позволяет добавить элементы в навигацию для пользователя.

3. `core\hook\navigation\course_extend`  
   Позволяет добавить дополнительные элементы в навигацию внутри курсов.

4. `core\hook\navigation\settings_extend`  
   Расширяет настройки навигации, например, для добавления новых опций в меню настроек.

5. `core\hook\navigation\admin_extend`  
   Расширяет администрирование навигации, например, добавление новых элементов в админ-панель.

6. `core\hook\navigation\my_extend`  
   Позволяет расширить меню "Мой Moodle" для добавления дополнительных ссылок или элементов.

7. `core\hook\navigation\extend_navigation`  
   Общее расширение навигации на сайте, которое позволяет вмешиваться в общую структуру навигационных элементов.

8. `core\hook\navigation\extend_course_navigation`  
   Добавление новых элементов в навигацию на уровне курса.

Подробнее про хуки: [Hooks API](hooks.md)

***

- **`extend_navigation`:** Этот хук используется для расширения навигации всего сайта или для добавления элементов в навигацию, которая отображается в панели слева или в другом месте интерфейса, в зависимости от темы. Это глобальный хук, который может использоваться для добавления новых элементов навигации.

  ```php
  function local_myplugin_extend_navigation(global_navigation $navigation) {
      // Логика добавления вкладки.
  }
  ```

  Этот хук вызывается для расширения глобальной навигации сайта, когда Moodle генерирует её. Он подходит для большинства случаев, когда нужно добавить вкладки или другие элементы в меню, которое отображается пользователю.

### Кастомизация Буста

Чтобы добавить вкладку в **navbar**, нужно использовать события рендеринга и кастомизировать их через класс `core_renderer`, который отвечает за рендеринг элементов навигации в темы.

> Здесь `navbar` это не совсем то. Было бы правильнее назвать его `Breadcrumb`.

**Пример кода для плагина:**

Файл `lib.php`
TODO протестировать код
```php
<?php
defined('MOODLE_INTERNAL') || die();

/**
 * Расширяет навигацию в теме Boost.
 */
function local_myplugin_extend_navigation(global_navigation $navigation) {
    global $PAGE, $USER;

    // Проверяем, авторизован ли пользователь.
    if (!isloggedin() || isguestuser()) {
        return; // Не добавляем вкладку для гостей.
    }

    // Проверяем права пользователя.
    $context = context_system::instance();
    if (!has_capability('local/myplugin:viewtab', $context)) {
        return; // Не добавляем вкладку, если нет нужного права.
    }

    // Добавляем вкладку в верхнюю навигацию (navbar).
    $tabname = get_string('mycustomtab', 'local_myplugin');
    $taburl = new moodle_url('/local/myplugin/index.php');
    $PAGE->navbar->add($tabname, $taburl);
}
```

Файл локализации `lang/en/local_myplugin.php`:
```php
<?php
$string['mycustomtab'] = 'My Custom Tab';
$string['pluginname'] = 'My Custom Plugin';
$string['myplugin:viewtab'] = 'View custom tab';
```

**Почему так:**

- `$PAGE->navbar->add()` — это метод, который добавляет новый элемент в верхнюю панель навигации (navbar), которая присутствует в теме Boost.
- Этот метод работает именно для **navbar** в тему Boost и других стандартных темах Moodle.

**Заключение:** Хук `extend_navigation` не добавляет элементы в **navbar**, а лишь в боковую панель (левую навигацию). Для **navbar** в Boost необходимо использовать `$PAGE->navbar->add()` внутри локального плагина, как показано выше.

***

TODO Events & Listener

