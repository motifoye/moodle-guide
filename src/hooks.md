# Хуки

Moodledev [Hooks API](https://moodledev.io/docs/4.5/apis/core/hooks)

**Хуки** -- это механизмы расширения функциональности, которые позволяют разработчикам выполнять кастомный код в определённых точках жизненного цикла приложения или при наступлении событий. В Moodle хуки дают возможность плагинам или темам вмешиваться в стандартное поведение без изменения исходного кода ядра.

## Общие понятия

### Hook emitter

Эмиттер хука - это место в коде, где ядро или плагин должны отправлять или получать информацию от/к другим плагинам. Точный тип информационного потока, поддерживаемого хуками, не определен.

### Hook instance

Информация, передаваемая между подсистемой и плагинами, инкапсулируется в произвольные экземпляры классов PHP. Они могут находиться в любом пространстве имен, но в общем случае их следует помещать в пространство имен `some_component\hook\*`.

Хукам рекомендуется описывать себя и предоставлять соответствующие метаданные, чтобы облегчить их использование и обнаружение. Существует два способа описать хук:

- реализовать интерфейс `\core\hook\described_hook`, который имеет два метода:
  - `get_description(): string;`
  - `get_tags(): массив;`
- добавьте в класс экземпляр следующих атрибутов:
  - `\core\attribute\label(string $description)`
  - `\core\attribute\tags($a, $set, $of, $tags, ...)`
  - `\core\attribute\hook\replaces_callbacks('a_list_of_legacy_callbacks', 'that_this_hook_replaces')`

### Hook callback

Moodle поддерживает упорядоченный список обратных вызовов для каждого класса хуков. Любой плагин может зарегистрировать свои собственные обратные вызовы хуков, создав файл db/hooks.php. Указанный метод обратного вызова плагина вызывается всякий раз, когда соответствующий хук отправлен. (relevant hook is dispatched)

### Hooks overview page

На странице обзора хуков перечислены все хуки, которые могут быть задействованы в системе, а также все зарегистрированные обратные вызовы. Она доступна разработчикам и администраторам из меню администрирования сайта.

В особых случаях администраторы могут переопределить приоритеты обратных вызовов хуков по умолчанию или полностью отключить некоторые ненужные обратные вызовы:

```php
/* /config.php */ 
$CFG->hooks_callback_overrides = [
    \mod_activity\hook\installation_finished::class => [
        'test_otherplugin\\callbacks::activity_installation_finished' => ['disabled' => true],
    ],
];
```

На странице обзора хуков будет автоматически выведен список всех хуков, которые размещены в любом пространстве имен `*\hook\*` в любом компоненте Moodle. Если вы определяете хук, который не находится в этом пространстве имен, то вы также должны определить новую реализацию `\core\hook\discovery_agent` в `[component]\hooks`.

## Dispatching hooks

После того как хук создан, его необходимо отправить. Ddispatcher отвечает за упорядочивание всех слушателей и вызов их с данными хука.

Менеджер хуков отвечает за отправку экземпляров хуков с помощью метода `dispatch(object $hook)`.

Метод `dispatch` является методом экземпляра и требует наличия экземпляра менеджера хуков.
